# =============================================================================
# Common Services (shared infrastructure)
# =============================================================================

services:
  postgres:
    image: postgres:15-alpine
    container_name: kitchen_postgres
    environment:
      POSTGRES_DB: kitchen_db
      POSTGRES_USER: kitchen_user
      POSTGRES_PASSWORD: kitchen_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kitchen_user -d kitchen_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - kitchen_network

  frostbyte_db_migrator:
    image: postgres:15-alpine
    container_name: frostbyte_db_migrator
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
      PGHOST: postgres
    volumes:
      - ./apps/frostbyte/database:/database:ro
    entrypoint: ["/database/migrate.sh"]
    networks:
      - kitchen_network
    restart: "no"

  labelmaker_db_migrator:
    image: postgres:15-alpine
    container_name: labelmaker_db_migrator
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
      PGHOST: postgres
    volumes:
      - ./apps/labelmaker/database:/database:ro
    entrypoint: ["/database/migrate.sh"]
    networks:
      - kitchen_network
    restart: "no"

  postgrest:
    image: postgrest/postgrest:v12.0.2
    container_name: kitchen_postgrest
    environment:
      PGRST_DB_URI: postgres://kitchen_user:kitchen_password@postgres:5432/kitchen_db
      PGRST_DB_SCHEMA: frostbyte_api,labelmaker_api
      PGRST_DB_ANON_ROLE: kitchen_user
      PGRST_OPENAPI_SERVER_PROXY_URI: http://localhost/api/db
    depends_on:
      postgres:
        condition: service_healthy
      frostbyte_db_migrator:
        condition: service_completed_successfully
      labelmaker_db_migrator:
        condition: service_completed_successfully
    networks:
      - kitchen_network

  printer_service:
    build:
      context: ./common/printer_service
      dockerfile: Dockerfile
    container_name: kitchen_printer
    environment:
      DRY_RUN: "true"
      APP_HOST: localhost
      PRINTER_MODEL: QL-800
      PRINTER_TAPE: "62"
    volumes:
      - ./labels_output:/app/labels_output
    networks:
      - kitchen_network

# =============================================================================
# FrostByte App Services
# =============================================================================

  frostbyte_client_builder:
    build:
      context: ./apps/frostbyte/client
      target: builder
    container_name: frostbyte_client_builder
    working_dir: /app
    command: npm run build
    volumes:
      - ./apps/frostbyte/client:/app
      - frostbyte_client_dist:/app/dist
      - frostbyte_client_node_modules:/app/node_modules
    networks:
      - kitchen_network

# =============================================================================
# LabelMaker App Services
# =============================================================================

  labelmaker_client_builder:
    build:
      context: ./apps/labelmaker/client
      target: builder
    container_name: labelmaker_client_builder
    working_dir: /app
    command: npm run build
    volumes:
      - ./apps/labelmaker/client:/app
      - labelmaker_client_dist:/app/dist
      - labelmaker_client_node_modules:/app/node_modules
    networks:
      - kitchen_network

  caddy:
    image: caddy:2-alpine
    container_name: kitchen_caddy
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./common/gateway/Caddyfile:/etc/caddy/Caddyfile:ro
      - frostbyte_client_dist:/srv/client:ro
      - labelmaker_client_dist:/srv/labelmaker:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      postgrest:
        condition: service_started
      printer_service:
        condition: service_started
      frostbyte_client_builder:
        condition: service_completed_successfully
      labelmaker_client_builder:
        condition: service_completed_successfully
    networks:
      - kitchen_network

  gobackup:
    build:
      context: ./common/backup
    container_name: kitchen_gobackup
    ports:
      - "2703:2703"
    environment:
      PGHOST: postgres
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
    volumes:
      - ./common/backup/gobackup.yml:/etc/gobackup/gobackup.yml:ro
      - gobackup_json:/data/json
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - kitchen_network

volumes:
  postgres_data:
  frostbyte_client_dist:
  frostbyte_client_node_modules:
  labelmaker_client_dist:
  labelmaker_client_node_modules:
  caddy_data:
  caddy_config:
  gobackup_json:

networks:
  kitchen_network:
    driver: bridge
