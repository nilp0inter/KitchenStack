# =============================================================================
# Common Services (shared infrastructure)
# =============================================================================

services:
  postgres:
    image: postgres:15-alpine
    container_name: kitchen_postgres
    environment:
      POSTGRES_DB: kitchen_db
      POSTGRES_USER: kitchen_user
      POSTGRES_PASSWORD: kitchen_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kitchen_user -d kitchen_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - kitchen_network

  frostbyte_db_migrator:
    image: postgres:15-alpine
    container_name: frostbyte_db_migrator
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
      PGHOST: postgres
    volumes:
      - ./apps/frostbyte/database:/database:ro
    entrypoint: ["/database/migrate.sh"]
    networks:
      - kitchen_network
    restart: "no"

  labelmaker_db_migrator:
    image: postgres:15-alpine
    container_name: labelmaker_db_migrator
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
      PGHOST: postgres
    volumes:
      - ./apps/labelmaker/database:/database:ro
    entrypoint: ["/database/migrate.sh"]
    networks:
      - kitchen_network
    restart: "no"

  postgrest:
    image: postgrest/postgrest:v12.0.2
    container_name: kitchen_postgrest
    environment:
      PGRST_DB_URI: postgres://kitchen_user:kitchen_password@postgres:5432/kitchen_db
      PGRST_DB_SCHEMA: frostbyte_api,labelmaker_api
      PGRST_DB_ANON_ROLE: kitchen_user
      PGRST_OPENAPI_SERVER_PROXY_URI: http://localhost/api/db
    depends_on:
      postgres:
        condition: service_healthy
      frostbyte_db_migrator:
        condition: service_completed_successfully
      labelmaker_db_migrator:
        condition: service_completed_successfully
    networks:
      - kitchen_network

  printer_service:
    build:
      context: ./common/printer_service
      dockerfile: Dockerfile
    container_name: kitchen_printer
    environment:
      DRY_RUN: "true"
      APP_HOST: localhost
      PRINTER_MODEL: QL-800
      PRINTER_TAPE: "62"
    volumes:
      - ./labels_output:/app/labels_output
    networks:
      - kitchen_network

  storage:
    image: versity/versitygw:latest
    container_name: kitchen_storage
    command:
      - posix
      - /data
      - --iam-dir
      - /config/iam
    environment:
      ROOT_ACCESS_KEY_ID: kitchen_storage_key
      ROOT_SECRET_ACCESS_KEY: kitchen_storage_secret
      VGW_PORT: ":7070"
    volumes:
      - storage_data:/data
      - storage_config:/config
    healthcheck:
      test: ["CMD-SHELL", "wget -q -S -O /dev/null http://localhost:7070/ 2>&1 | grep -q '403\\|200'"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - kitchen_network

  storage_init:
    image: amazon/aws-cli:latest
    container_name: kitchen_storage_init
    depends_on:
      storage:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: kitchen_storage_key
      AWS_SECRET_ACCESS_KEY: kitchen_storage_secret
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        aws --endpoint-url http://storage:7070 s3 mb s3://frostbyte-assets 2>/dev/null || true
        aws --endpoint-url http://storage:7070 s3 mb s3://labelmaker-assets 2>/dev/null || true
        echo '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":"*","Action":["s3:GetObject","s3:PutObject"],"Resource":"arn:aws:s3:::frostbyte-assets/*"}]}' > /tmp/policy.json
        aws --endpoint-url http://storage:7070 s3api put-bucket-policy --bucket frostbyte-assets --policy file:///tmp/policy.json
        echo '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":"*","Action":["s3:GetObject","s3:PutObject"],"Resource":"arn:aws:s3:::labelmaker-assets/*"}]}' > /tmp/policy.json
        aws --endpoint-url http://storage:7070 s3api put-bucket-policy --bucket labelmaker-assets --policy file:///tmp/policy.json
        echo "Storage buckets initialized"
    networks:
      - kitchen_network
    restart: "no"

# =============================================================================
# FrostByte App Services
# =============================================================================

  frostbyte_client_builder:
    build:
      context: ./apps/frostbyte/client
      target: builder
    container_name: frostbyte_client_builder
    working_dir: /app
    command: npm run build
    volumes:
      - ./apps/frostbyte/client:/app
      - frostbyte_client_dist:/app/dist
      - frostbyte_client_node_modules:/app/node_modules
    networks:
      - kitchen_network

# =============================================================================
# LabelMaker App Services
# =============================================================================

  labelmaker_client_builder:
    build:
      context: ./apps/labelmaker/client
      target: builder
    container_name: labelmaker_client_builder
    working_dir: /app
    command: npm run build
    volumes:
      - ./apps/labelmaker/client:/app
      - labelmaker_client_dist:/app/dist
      - labelmaker_client_node_modules:/app/node_modules
    networks:
      - kitchen_network

  caddy:
    image: caddy:2-alpine
    container_name: kitchen_caddy
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./common/gateway/Caddyfile:/etc/caddy/Caddyfile:ro
      - frostbyte_client_dist:/srv/client:ro
      - labelmaker_client_dist:/srv/labelmaker:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      postgrest:
        condition: service_started
      printer_service:
        condition: service_started
      storage_init:
        condition: service_completed_successfully
      frostbyte_client_builder:
        condition: service_completed_successfully
      labelmaker_client_builder:
        condition: service_completed_successfully
    networks:
      - kitchen_network

  gobackup:
    build:
      context: ./common/backup
    container_name: kitchen_gobackup
    ports:
      - "2703:2703"
    environment:
      PGHOST: postgres
      PGUSER: kitchen_user
      PGPASSWORD: kitchen_password
      PGDATABASE: kitchen_db
    volumes:
      - ./common/backup/gobackup.yml:/etc/gobackup/gobackup.yml:ro
      - gobackup_json:/data/json
      - storage_data:/data/storage:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - kitchen_network

volumes:
  postgres_data:
    name: kitchen_postgres_data
    external: true
  storage_data:
    name: kitchen_storage_data
    external: true
  storage_config:
  frostbyte_client_dist:
  frostbyte_client_node_modules:
  labelmaker_client_dist:
  labelmaker_client_node_modules:
  caddy_data:
  caddy_config:
  gobackup_json:

networks:
  kitchen_network:
    driver: bridge
