# Kitchen Management Stack â€” Caddy Configuration
{
    # For local development, use HTTP only
    auto_https off
}

# =============================================================================
# FrostByte (:80)
# =============================================================================

:80 {
    # Serve the Elm PWA static files
    root * /srv/client

    # Handle SPA routing - try files first, then fall back to index.html
    @notApi {
        not path /api/*
    }

    handle @notApi {
        try_files {path} /index.html
        file_server
    }

    # Proxy PostgREST API requests (pinned to frostbyte_api schema)
    handle /api/db/* {
        uri strip_prefix /api/db
        reverse_proxy postgrest:3000 {
            header_up Accept-Profile frostbyte_api
            header_up Content-Profile frostbyte_api
        }
    }

    # Proxy Asset Storage requests (FrostByte bucket)
    handle /api/assets/* {
        uri strip_prefix /api/assets
        uri path_regexp .* /frostbyte-assets{path}
        reverse_proxy storage:7070
    }

    # Proxy Printer Service API requests
    handle /api/printer/* {
        uri strip_prefix /api/printer
        reverse_proxy printer_service:8000
    }

    # Enable gzip compression
    encode gzip

    # Logging
    log {
        output stdout
        format console
    }
}

# =============================================================================
# LabelMaker (:8080)
# =============================================================================

:8080 {
    root * /srv/labelmaker

    @notApi {
        not path /api/*
    }

    handle @notApi {
        try_files {path} /index.html
        file_server
    }

    # Proxy PostgREST API requests (pinned to labelmaker_api schema)
    handle /api/db/* {
        uri strip_prefix /api/db
        reverse_proxy postgrest:3000 {
            header_up Accept-Profile labelmaker_api
            header_up Content-Profile labelmaker_api
        }
    }

    # Proxy Asset Storage requests (LabelMaker bucket)
    handle /api/assets/* {
        uri strip_prefix /api/assets
        uri path_regexp .* /labelmaker-assets{path}
        reverse_proxy storage:7070
    }

    handle /api/printer/* {
        uri strip_prefix /api/printer
        reverse_proxy printer_service:8000
    }

    encode gzip

    log {
        output stdout
        format console
    }
}
